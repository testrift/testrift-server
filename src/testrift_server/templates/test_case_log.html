<!DOCTYPE html>
<html lang="en" class="dark-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    {% set resolved_tc_id = (
        test_case.tc_id if test_case and test_case.tc_id
        else (
            tc_meta.tc_id
            if (tc_meta is defined and tc_meta and tc_meta.tc_id)
            else test_case_id
        )
    ) %}
    {% set resolved_full_name = (
        test_case.full_name if test_case and test_case.full_name
        else (
            tc_meta.tc_full_name
            if (tc_meta is defined and tc_meta and tc_meta.tc_full_name)
            else test_case_id
        )
    ) %}
    <title>Test Case Log {{ resolved_full_name }}</title>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    {% if server_mode %}
    <script src="/static/at_syntax.js"></script>
    {% else %}
    <script src="../static/at_syntax.js"></script>
    {% endif %}
    {% if server_mode %}
    <link href="/static/status-badges.css" rel="stylesheet">
    <link href="/static/test_case_log.css" rel="stylesheet">
    <link href="/static/classifications.css" rel="stylesheet">
    <script src="/static/classifications.js"></script>
    {% else %}
    <link href="../static/status-badges.css" rel="stylesheet">
    <link href="../static/test_case_log.css" rel="stylesheet">
    {% endif %}
</head>
<body>
    <div class="main-container">
        <div class="sidebar-layout">
                <div class="devices-sidebar" id="devicesSidebar">
                    <div class="sidebar-header">
                        <div class="sidebar-tabs">
                            <div class="tab-item active" id="devicesTab">Sources</div>
                            <div class="tab-item" id="filterTab">Filter</div>
                        </div>
                        <button class="sidebar-toggle" id="sidebarToggle"></button>
                    </div>
                    <div class="sidebar-content">
                        <div class="tab-content active" id="devicesContent">
            <ul id="src_list" class="list-unstyled"></ul>
        </div>
                        <div class="tab-content" id="filterContent">
                            <div class="filter-section">
                                <div class="filter-input-group">
                                    <input type="text" id="filterInput" class="filter-input" placeholder="Enter filter text...">
                                    <button class="filter-clear-btn" id="filterClearBtn" title="Clear filter">âœ•</button>
                    </div>
                                <div class="filter-options">
                                    <label class="filter-option">
                                        <input type="checkbox" id="caseSensitive"> Case sensitive
                                    </label>
                                    <label class="filter-option">
                                        <input type="checkbox" id="fullWord"> Full word only
                                    </label>
                                    <label class="filter-option">
                                        <input type="checkbox" id="useWildcards"> Use wildcards (*, ?)
                                    </label>
                </div>
                                <div class="filter-mode">
                                    <label class="filter-option">
                                        <input type="radio" name="filterMode" value="include" checked> Include matches
                                    </label>
                                    <label class="filter-option">
                                        <input type="radio" name="filterMode" value="exclude"> Exclude matches
                                    </label>
            </div>
                                <div class="filter-status" id="filterStatus">
                                    No filter applied
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="main-content">
{% if not server_mode %}
  {% include 'static_banner.html' %}
{% endif %}
                    <div class="header-section">
                        <h1>Test Case Log</h1>
                        <p><a href="{% if server_mode %}/testRun/{{ run.id if run else run_id }}/index.html{% else %}../index.html{% endif %}" class="back-link">&larr; Back to {{ run_name }}</a></p>
                    </div>

                    <div class="info-card">
                        <div class="test-details-header">
                            <div class="tc-title-row">
                                <h4 class="tc-full-name">{{ resolved_full_name }}<span id="new-tc-indicator"></span></h4>
                                <div class="status-container">
                                    <span id="tc-status-badge" class="status-badge">
                                        <!-- Status will be populated by JavaScript -->
                                    </span>
                                    <span id="tc-classification-icon"></span>
                                </div>
                            </div>
                            <div class="tc-timing-row">
                                <span id="tc-start-time-display" class="tc-start-time"></span>
                                <span id="tc-execution-time" class="execution-time" style="display: none;"></span>
                            </div>
                        </div>
                        <div class="info-grid">
                            {% set user_metadata = run.user_metadata if run else (run_meta.user_metadata if run_meta else {}) %}
                            {% for name, metadata in user_metadata.items() %}
                            <div class="info-item">
                                <strong>{{ name }}</strong>
                                {% if metadata.url %}
                                    <a href="{{ metadata.url }}" target="_blank">{{ metadata.value }}</a>
                                {% else %}
                                    {{ metadata.value }}
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        <div id="retention-notice" class="retention-notice" style="display: none;"></div>

                        <!-- Attachments Header -->
                        <div class="attachments-header">
                            <h5>Attachments</h5>
                        </div>
                        <div class="attachments-list" id="attachmentsList">
                            <!-- Attachments will be loaded here -->
                        </div>

                        <div class="stack-trace-section" id="stackTraceSection">
                            <div class="stack-trace-header">
                                <h5>Stack Traces</h5>
                            </div>
                            <div class="stack-trace-list" id="stackTraceList">
                                <!-- Stack traces populated by JavaScript -->
                            </div>
                            <div class="stack-trace-empty" id="stackTraceEmptyState">No stack traces reported.</div>
                        </div>
                    </div>


                    <div class="log-section">
                        <div class="log-header">
                <h2>Message Log</h2>
                            <div class="log-controls">
                                <button id="time-display-toggle" class="btn btn-sm btn-outline-secondary">
                                    Show Delta Time
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table id="msg_table" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Channel</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Initial log entries will be populated here -->
                        {% set entries = (test_case.logs if test_case and test_case.logs is defined else logs) %}
                        {% for entry in entries %}
                        <tr>
                            <td class="fit" data-original-time="{{ entry.timestamp }}">{{ entry.timestamp }}</td>
                            <td class="fit">
                                {% if entry.component or entry.channel %}
                                    <span class="badge badge-custom" style="background-color: #4ECDC4;">{{ entry.component or 'Unknown' }}</span>
                                    {% if entry.channel %}
                                        <span class="badge badge-custom" style="background-color: #45B7D1;">{{ entry.channel }}</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>{{ entry.message }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

  <!-- Template configuration - all template expressions consolidated here -->
<script>
    const templateConfig = {
    runId: {{ (run.id if run else run_id) | tojson }},
    testCaseId: {{ resolved_tc_id | tojson }},
    testCaseFullName: {{ resolved_full_name | tojson }},
      testCaseStatus: {{ (test_case.status if test_case else (tc_meta.status if tc_meta else '')) | tojson }},
      testCaseStartTime: {{ (test_case.start_time if test_case else (tc_meta.start_time if tc_meta else '')) | tojson }},
      testCaseEndTime: {{ (test_case.end_time if test_case else (tc_meta.end_time if tc_meta else '')) | tojson }},
      runStartTime: {{ (run.start_time if run else (run_meta.start_time if run_meta else '')) | tojson }},
      retentionDays: {{ (run.retention_days if run else (run_meta.retention_days if run_meta else 0)) | tojson }},
      initialLogs: {{ logs | tojson }},
      liveRun: {{ live_run | tojson }},
      serverMode: {{ server_mode | tojson }},
      attachments: {{ attachments | tojson if attachments else '[]' }},
      stackTraces: {{ (stack_traces if stack_traces is defined else (test_case.stack_traces if test_case else (tc_meta.stack_traces if tc_meta else []))) | tojson }},
      groupHash: {{ group_hash | tojson if group_hash else 'null' }}
    };
</script>

  <!-- Load the shared JavaScript file -->
  <script src="{% if server_mode %}/static/test_case_log.js{% else %}../static/test_case_log.js{% endif %}"></script>

{% if server_mode %}
<script>
// Load and display classification for this test case
async function loadTestCaseClassification() {
    if (!templateConfig.serverMode || typeof Classifications === 'undefined') return;

    try {
        const data = await Classifications.fetchClassifications(templateConfig.runId);
        // Classifications are keyed by tc_full_name, not tc_id
        const classData = data[templateConfig.testCaseFullName];

        if (!classData) return;

        // Add classification icon
        if (classData.classification) {
            const iconContainer = document.getElementById('tc-classification-icon');
            if (iconContainer) {
                const icon = Classifications.createClassificationIcon(classData.classification);
                iconContainer.appendChild(icon);
            }
        }

        // Add new TC indicator
        if (classData.is_new) {
            const indicatorContainer = document.getElementById('new-tc-indicator');
            if (indicatorContainer) {
                const indicator = Classifications.createNewTcIndicator();
                indicatorContainer.appendChild(indicator);
            }
        }

        // Setup hover history on status badge - fetch both previous and latest
        const statusBadge = document.getElementById('tc-status-badge');
        if (statusBadge) {
            // Use async method to fetch both previous and latest results
            Classifications.setupBadgeHistoryHoverAsync(
                statusBadge,
                templateConfig.testCaseId,
                templateConfig.groupHash || null,
                templateConfig.runId,
                templateConfig.testCaseFullName
            );
        }
    } catch (error) {
        console.error('Error loading classification:', error);
    }
}

// Load classification after page is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadTestCaseClassification);
} else {
    loadTestCaseClassification();
}
</script>
{% endif %}

</body>
</html>