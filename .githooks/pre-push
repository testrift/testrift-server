#!/usr/bin/env sh
set -eu

# Reject pushing version tags that don't match VERSION file
#
# Expected tag format: vX.Y.Z (or X.Y.Z)

repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [ -z "$repo_root" ]; then
  exit 0
fi

version_file="$repo_root/VERSION"
if [ ! -f "$version_file" ]; then
  exit 0
fi

pkg_version="$(cat "$version_file" | tr -d '[:space:]')"
if [ -z "$pkg_version" ]; then
  echo "ERROR: VERSION file is empty." >&2
  exit 1
fi

while read -r local_ref local_sha remote_ref remote_sha; do
  case "$local_ref" in
    refs/tags/*)
      tag="${local_ref#refs/tags/}"
      case "$tag" in
        v*) tag_version="${tag#v}" ;;
        *) tag_version="$tag" ;;
      esac

      case "$tag_version" in
        ""|*[!0-9.]*)
          # Ignore non-version-ish tags (e.g. "docs", "nightly", etc.)
          continue
          ;;
      esac

      if [ "$tag_version" != "$pkg_version" ]; then
        echo "ERROR: Refusing to push tag '$tag' (version $tag_version) because VERSION file contains '$pkg_version'." >&2
        echo "Fix one of these and retry:" >&2
        echo "  - update VERSION file" >&2
        echo "  - recreate the tag to match the version (e.g. v$pkg_version)" >&2
        exit 1
      fi
      ;;
  esac
done

exit 0


